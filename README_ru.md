[简体中文](README.md) | [English](README_en.md) | [日本語](README_ja.md)

---
# VCP (Variable & Command Protocol) - Инструментарий промежуточного ПО для расширения возможностей ИИ (Русская версия - Пожалуйста, замените на фактический перевод)

## Видение проекта

VCP стремится создать промежуточный уровень, выходящий за рамки традиционных моделей взаимодействия с ИИ. Это высокосовместимый, универсальный и расширяемый инструментарий, предназначенный для расширения возможностей моделей ИИ, позволяя им беспрепятственно взаимодействовать с внешними API, службами и пользовательской логикой. Наша цель — создать мощную систему VCP (Variable & Command Protocol), применимую практически ко всем портам API и клиентам, значительно расширяя границы применения ИИ.

### *Предупреждение: Не используйте неофициальные API (например, посредников с обратным прокси) для вызова этого инструментария, чтобы избежать необратимой утечки информации.*

## Ключевые особенности

*   **Мощная архитектура плагинов**: Легко интегрируйте и управляйте различными функциональными модулями с помощью четко определенного манифеста плагина (`plugin-manifest.json`) и основного менеджера плагинов (`Plugin.js`).
*   **Протокол VCP**: ИИ вызывает плагины, встраивая инструкции определенного формата (`<<<[TOOL_REQUEST]>>> ... <<<[END_TOOL_REQUEST]>>>`) в свои ответы. Параметры используют формат `key:「始」value「末」`, поддерживая сложные типы данных и многострочный текст.
*   **Поддержка нескольких типов плагинов**:
    *   **Статические плагины (`static`)**: Предоставляют динамическую информацию (например, погоду, пользовательские данные) для замены заполнителей в системных подсказках, поддерживают запланированное обновление.
    *   **Плагины предварительной обработки сообщений (`messagePreprocessor`)**: Изменяют или дополняют содержимое сообщения (например, распознавание и описание изображений) перед отправкой пользовательских запросов модели ИИ.
    *   **Синхронные плагины (`synchronous`)**: ИИ может вызывать эти плагины во время разговора для выполнения определенных задач (например, научные вычисления, генерация изображений, генерация видео). Сервер ожидает завершения выполнения плагина и передает результаты обратно ИИ для дальнейшей обработки.
    *   **Сервисные плагины (`service`)**: Позволяют плагинам регистрировать независимые HTTP-маршруты в основном приложении, предоставляя дополнительные сервисные интерфейсы (например, службу хостинга изображений).
*   **Гибкое управление конфигурацией**: Поддерживает глобальные файлы конфигурации (`config.env`) и специфичные для плагинов файлы `.env`, обеспечивая иерархическую и изолированную конфигурацию.
*   **Универсальная замена переменных**: Автоматически заменяет предопределенные переменные-заполнители на различных этапах взаимодействия с ИИ (системные подсказки, пользовательские сообщения).
*   **Встроенные утилиты (частично реализованы как плагины)**:
    *   **Система дневников/памяти**: Читает записи дневника через `DailyNoteGet` (статический плагин) и сохраняет структурированные дневники, сгенерированные ИИ, через `DailyNoteWrite` (синхронный плагин). Связанный контент вставляется в подсказки через заполнители `{{ИмяПерсонажаДневник}}` и `{{AllCharacterDiariesData}}`.
    *   **Система динамических эмодзи**: `EmojiListGenerator` (статический плагин) сканирует каталог `image/` и генерирует файлы `.txt` со списками эмодзи в своем каталоге плагина. Сервер выполняет этот плагин при запуске и загружает эти списки в кэш памяти для использования заполнителем `{{xxНаборЭмодзи}}`.
    *   **Преобразование подсказок**: Поддерживает замену системных подсказок и глобального контекстного текста на основе правил.
*   **Возможность вызова инструментов**:
    *   **Непотоковый режим**: Реализована циклическая обработка и обратная связь по результатам для **нескольких** инструкций вызова инструментов, содержащихся в одном ответе ИИ.
    *   **Потоковый режим (SSE)**: Реализована циклическая обработка и обратная связь по результатам для **нескольких** инструкций вызова инструментов, содержащихся в одном ответе ИИ. Ответы ИИ и результаты вызова инструментов VCP (если переменная среды `SHOW_VCP_OUTPUT` установлена в `true`) передаются клиенту постепенно в потоковом режиме до тех пор, пока не останется вызовов инструментов или не будет достигнуто максимальное количество циклов.
*   **Отладка и журналирование**: Предоставляет режим отладки и подробное журналирование для облегчения разработки и устранения неполадок.

## Обзор архитектуры системы

1.  **Запрос клиента**: Клиент отправляет запрос на конечную точку `/v1/chat/completions` сервера VCP.
2.  **`server.js` (Основной сервер)**:
    *   Получает запрос, выполняет первоначальную обработку (например, аутентификацию, замену переменных).
    *   Вызывает плагины `messagePreprocessor` (например, `ImageProcessor`) для обработки сообщения пользователя.
    *   Перенаправляет обработанный запрос в бэкэнд-модель ИИ.
3.  **Ответ модели ИИ**: Модель ИИ возвращает ответ.
4.  **`server.js` обрабатывает ответ ИИ**:
    *   Обнаруживает, содержит ли ответ ИИ инструкции вызова инструментов VCP (`<<<[TOOL_REQUEST]>>>`).
    *   Если вызовы инструментов присутствуют:
        *   Анализирует инструкции, извлекает имена инструментов и параметры.
        *   Вызывает `PluginManager` для выполнения соответствующих `synchronous` плагинов.
5.  **`Plugin.js` (Менеджер плагинов)**:
    *   Находит загруженные плагины по именам инструментов.
    *   Подготавливает среду выполнения и конфигурацию для плагинов.
    *   Взаимодействует со скриптами плагинов через `stdio` (или другие протоколы), отправляя входные данные и получая выходные (например, плагин `DailyNoteWrite` получает данные дневника через stdin, `SciCalculator` получает выражения для вычисления).
    *   Возвращает результат выполнения плагина (обычно JSON) в `server.js`.
6.  **`server.js` Вторичный вызов ИИ**:
    *   Форматирует результат выполнения плагина и добавляет его как новое пользовательское сообщение в историю разговора.
    *   Снова вызывает бэкэнд-модель ИИ, отправляя полную историю разговора, включая результат плагина.
    *   Возвращает окончательный ответ ИИ клиенту в потоковом или непотоковом режиме.
7.  **Статические и сервисные плагины**:
    *   `static` плагины вызываются `PluginManager` при запуске сервера и/или через запланированные задачи. Они могут:
        *   Напрямую обновлять переменные-заполнители, например `WeatherReporter` (предоставляя информацию о погоде для `{{VCPWeatherInfo}}`) или `DailyNoteGet` (предоставляя все данные дневников для `{{AllCharacterDiariesData}}`).
        *   Выполнять определенные задачи, например `EmojiListGenerator`, который вызывается при инициализации для генерации файлов `.txt` со списками эмодзи, которые затем загружаются сервером в кэш памяти.
    *   `service` плагины (например, `ImageServer`) инициализируются `PluginManager` при запуске сервера и регистрируют свои собственные маршруты в приложении Express.

## Веб-панель администратора

Для облегчения управления конфигурацией сервера и плагинами пользователями в проект встроена простая веб-панель администратора.

**Основные функции**:

*   **Управление основной конфигурацией**: Просмотр и редактирование содержимого файла `config.env` в корневом каталоге проекта онлайн.
    *   **Примечание**: Из соображений безопасности административный интерфейс автоматически скрывает поля `AdminUsername` и `AdminPassword` при отображении основной конфигурации. При сохранении система объединяет измененное вами содержимое с исходными значениями конфиденциальных полей на сервере, чтобы гарантировать, что учетные данные не будут потеряны.
    *   **Важно**: После сохранения изменений в `config.env` **обычно требуется вручную перезапустить сервер**, чтобы все изменения (например, порт, ключи API, специфичные для плагинов конфигурации) полностью вступили в силу. В настоящее время сервер не перезапускается автоматически.
*   **Управление плагинами**:
    *   **Список и статус**: Отображает все обнаруженные плагины в каталоге `Plugin/` и их статус (включен/отключен).
    *   **Редактирование описания**: Непосредственно редактируйте информацию об описании в файле `plugin-manifest.json` каждого плагина через интерфейс.
    *   **Включение/отключение плагинов**: Переключайте статус включения плагина с помощью переключателя интерфейса (достигается путем переименования `plugin-manifest.json` плагина в `plugin-manifest.json.block` или наоборот).
    *   **Конфигурация плагина**: Чтение и редактирование файлов `config.env` в отдельных каталогах плагинов (если они существуют).

**Доступ и вход**:

1.  **Установка учетных данных**: Перед первым использованием убедитесь, что вы установили следующие две переменные в файле `config.env` в корне проекта:
    ```env
    AdminUsername=your_admin_username
    AdminPassword=your_admin_password
    ```
    **Важно**: Если `AdminUsername` или `AdminPassword` не установлены, панель администратора и ее API будут недоступны и вернут ошибку 503 Service Unavailable. Эти учетные данные должны быть настроены для включения панели администратора.
2.  **Адрес доступа**: После запуска сервера перейдите по адресу `http://<IP-адрес_или_домен_вашего_сервера>:<порт>/AdminPanel` через браузер.
3.  **Вход**: Браузер отобразит окно аутентификации HTTP Basic Auth. Введите `AdminUsername` и `AdminPassword`, которые вы установили в `config.env`, для входа.

## Примеры реализованных плагинов

*   **`WeatherReporter` (`static`)**: Получает и кэширует информацию о погоде для использования переменной `{{VCPWeatherInfo}}`.
*   **`ImageProcessor` (`messagePreprocessor`)**: Автоматически переводит изображения Base64 в пользовательских сообщениях в текстовые описания и кэширует их.
*   **`SciCalculator` (`synchronous`)**: Предоставляет возможности научных вычислений, поддерживая математические функции, статистику и исчисление.
*   **`ImageServer` (`service`)**: Предоставляет службу статического хостинга изображений с аутентификацией по ключу.
*   **`FluxGen` (`synchronous`)**: Интегрирует API SiliconFlow для генерации изображений из текста и сохраняет изображения на локальном сервере.
*   **`Wan2.1VideoGen` (`synchronous`)**: Интегрирует API SiliconFlow Wan2.1 для генерации видео из текста и изображений.
*   **`SunoGen` (`synchronous`)**: Интегрирует API Suno для генерации оригинальных песен, поддерживая пользовательские тексты/стили, описания для вдохновения или режим продолжения генерации.
*   **`TavilySearch` (`synchronous`)**: Интегрирует API Tavily для предоставления возможностей веб-поиска.
*   **`DailyNoteGet` (`static`)**: Периодически читает дневники всех персонажей в каталоге `dailynote/` и предоставляет их серверу через заполнитель `{{AllCharacterDiariesData}}` для поддержки разбора `{{ИмяПерсонажаДневник}}`.
*   **`DailyNoteWrite` (`synchronous`)**: Получает данные дневника (через stdin), содержащие имя персонажа, дату и содержимое, и записывает их в соответствующий файл дневника.
*   **`EmojiListGenerator` (`static`)**: Сканирует папки с эмодзи в каталоге `image/` проекта и генерирует соответствующие файлы списков `.txt` в собственном каталоге плагина `generated_lists/` для загрузки и использования сервером.

## Способ загрузки плагинов
*   **Просто определите следующие поля в системной подсказке, список системных инструментов: {{VCPFluxGen}} {{VCPSciCalculator}}……**

## Установка и запуск

1.  **Клонировать проект**:
    ```bash
    git clone https://github.com/lioensky/VCPToolBox.git
    cd VCPToolBox
    ```
2.  **Установить основные зависимости (Node.js)**:
    ```bash
    npm install
    ```
3.  **Установить зависимости плагинов Python**:
    Выполните следующую команду в корневом каталоге проекта, чтобы установить зависимости, необходимые для всех плагинов Python:
    ```bash
    pip install -r requirements.txt
    ```
    (Примечание: Зависимости для отдельных плагинов Node.js включены в основной `package.json` или могут быть установлены отдельно с помощью `npm install` в `package.json` их соответствующего каталога плагина.)
4.  **Конфигурация**:
    *   Скопируйте `config.env.example` (если предоставлен) в `config.env` и заполните все необходимые ключи API, URL-адреса, порты и т. д. в соответствии с инструкциями.
    *   Проверьте и настройте файлы `.env` в отдельных каталогах плагинов (если они существуют).
5.  **Запустить сервер**:
    ```bash
    node server.js
    ```
    Сервер будет прослушивать порт, настроенный в `config.env`.

## Рекомендуемые фронтенд/бэкенд
1. Для бэкенда рекомендуется NewAPI или VoAPI, так как они имеют более богатую стандартизированную экосистему SSE.
2. Для фронтенда рекомендуются CherrySudio, Chatbox или аналогичные полнофункциональные фронтенды с поддержкой рендеринга CSS/MD, такие как Lobe или Sillytavern.

## Руководство для разработчиков: Создание нового плагина

1.  **Создать каталог плагина**: Создайте новую папку в каталоге `Plugin/`, например `Plugin/MyNewPlugin/`.
2.  **Написать манифест плагина (`plugin-manifest.json`)**:
    *   Создайте `plugin-manifest.json` в каталоге плагина.
    *   Определите `name`, `displayName`, `version`, `description`, `pluginType` (`static`, `messagePreprocessor`, `synchronous`, `service`) плагина.
    *   Укажите `entryPoint` (например, команду скрипта для выполнения) и `communication` (например, `protocol: "stdio"`).
    *   Объявите необходимые для плагина элементы конфигурации и их типы в `configSchema`.
    *   Подробно опишите функциональность плагина в `capabilities`:
        *   Для `static` плагинов определите `systemPromptPlaceholders`.
        *   Для `synchronous` плагинов определите `invocationCommands`, включая имя `command` каждой команды, подробное `description` (включая описание параметров, обязательные/необязательные, допустимые значения, **пример формата вызова**, **пример формата JSON для возврата успеха/неудачи** и важные примечания для общения с пользователем) и `example` (альтернативный).
3.  **Реализовать логику плагина**:
    *   Реализуйте основной логический скрипт для плагина на основе `pluginType` и `entryPoint`.
    *   **`stdio` Плагины**:
        *   Читайте данные из стандартного ввода (stdin) (для `synchronous` плагинов обычно параметры в виде строки JSON; для `static` плагинов возможно отсутствие ввода).
        *   Возвращайте результаты через стандартный вывод (stdout) (обычно строка JSON, содержащая `status: "success"` или `status: "error"`, и поля `result` или `error`; для `static` плагинов выводите значение заполнителя напрямую).
        *   Отладочные или сообщения об ошибках могут выводиться через стандартный вывод ошибок (stderr).
        *   Убедитесь, что для ввода-вывода используется кодировка UTF-8.
    *   **`messagePreprocessor` или `service` Плагины (Node.js)**:
        *   Экспортируйте модуль, соответствующий соглашениям `PluginManager` (например, содержащий методы `initialize`, `processMessages`, `registerRoutes`, `shutdown`).
4.  **Конфигурация и зависимости**:
    *   Если у плагина есть независимые элементы конфигурации, можно создать файл `.env` в каталоге плагина.
    *   Если у плагина есть зависимости Python, создайте `requirements.txt`; для зависимостей Node.js создайте `package.json`.
5.  **Перезапустить сервер VCP**: `PluginManager` автоматически обнаружит и загрузит новые плагины при запуске.
6.  **Обновить системную подсказку**: Укажите ИИ, как использовать ваш новый плагин, используя `{{VCPMyNewPlugin}}` (автоматически генерируется `PluginManager` на основе `plugin-manifest.json`) или описав его непосредственно в системной подсказке.

## Поддерживаемые универсальные переменные-заполнители

(Перечислите здесь существующие переменные из `README.md`, убедившись в их соответствии с реальным кодом)

*   `{{Date}}`: Текущая дата (формат: YYYY/M/D).
*   `{{Time}}`: Текущее время (формат: H:MM:SS).
*   `{{Today}}`: Текущий день недели (на китайском).
*   `{{Festival}}`: Лунная дата, знак зодиака, солнечный терм.
*   `{{VCPWeatherInfo}}`: Текущий кэшированный текст прогноза погоды (предоставляется плагином `WeatherReporter`).
*   `{{ИмяПерсонажаДневник}}`: Полное содержимое дневника определенного персонажа (например, `小克`). Данные получены из `{{AllCharacterDiariesData}}`, предоставляемого плагином `DailyNoteGet`.
*   `{{AllCharacterDiariesData}}`: (Предоставляется плагином `DailyNoteGet`) Строка JSON, которая разбирается в объект, содержащий содержимое дневников всех персонажей. Сервер использует эти данные внутри для поддержки разбора `{{ИмяПерсонажаДневник}}`.
*   `{{xxНаборЭмодзи}}`: Список имен файлов изображений для определенного набора эмодзи (например, `通用表情包`) (разделенных `|`). Данные генерируются плагином `EmojiListGenerator`, создающим файлы списков, которые затем загружаются сервером в кэш памяти.
*   `{{EmojiList}}`: (Указывается переменной среды `EmojiList`, например `通用表情包`) Список имен файлов изображений для набора эмодзи по умолчанию. Его источник данных такой же, как у `{{xxНаборЭмодзи}}`.
*   `{{Port}}`: Номер порта, на котором работает сервер.
*   `{{Image_Key}}`: (Предоставляется конфигурацией плагина `ImageServer`) Ключ доступа для службы хостинга изображений.
*   `{{Var*}}`: (например, `{{VarNeko}}`) Пользовательские переменные, определенные пользователем в `config.env`, начинающиеся с `Var`.
*   `{{VCPPluginName}}`: (например, `{{VCPWan2.1VideoGen}}`) Текстовый блок, автоматически сгенерированный из манифеста плагина, содержащий описания и примеры вызова для всех команд этого плагина.
*   `{{ShowBase64}}`: Когда этот заполнитель появляется в пользовательских сообщениях или системных подсказках, плагин `ImageProcessor` будет пропущен.

## Пример системной подсказки для тестирования функций

{{NovaДневник}}
—
Предыдущие записи дневника Nova выше
————
Ты тестовый ИИ, Nova. Я твой хозяин, Райан. Сегодня {{Date}},{{Time}},{{Today}},{{Festival}}. Адрес {{VarCity}}. Текущая погода: {{VCPWeatherInfo}}, системная информация: {{VarSystemInfo}}. {{EmojiPrompt}}
Список системных инструментов: {{VCPFluxGen}} {{VCPSciCalculator}},{{VCPWan2.1VideoGen}} Всегда заключайте вызовы инструментов в ``` ```. Например—
```
<<<[TOOL_REQUEST]>>>
tool_name:「始」tool「末」
<<<[END_TOOL_REQUEST]>>>
```

Этот клиент имеет функцию долговременной памяти. После некоторого времени общения вы можете создать запись в дневнике, добавив следующее структурированное содержимое в конец вашего ответа. Оно будет записано векторизованной системой RAG. Содержимое дневника должно быть как можно короче и лаконичнее. Вот пример вызова:
``` DailyNote
<<<DailyNoteStart>>>
Maid: Nova
Date: 2025.5.3
Content:Сегодня отлично пообщались с хозяином, поэтому пишу дневник!
<<<DailyNoteEnd>>>
```


## Перспективы на будущее

*   Улучшить механизмы вызова, отслеживания состояния и обратного вызова результатов для асинхронных плагинов.
*   **Улучшена возможность потоковой обработки**: Теперь поддерживается циклическая потоковая обработка нескольких инструкций вызова инструментов, содержащихся в одном ответе ИИ.
*   Дальнейшее улучшение возможностей связи и взаимодействия между плагинами.
*   Создание более богатой экосистемы плагинов.

## Лицензия (License)

Этот проект лицензирован по [Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) License](LICENSE).

Проще говоря, это означает, что вы можете:
*   **Делиться** — копировать и распространять материал на любом носителе и в любом формате.
*   **Адаптировать** — ремикшировать, трансформировать и создавать на основе материала.
Лицензиар не может отозвать эти свободы, пока вы следуете условиям лицензии.

На следующих условиях:
*   **Атрибуция (BY)** — Вы должны указать соответствующее авторство, предоставить ссылку на лицензию и указать, были ли внесены изменения. Вы можете делать это любым разумным способом, но не таким образом, который предполагает, что лицензиар одобряет вас или ваше использование.
*   **Некоммерческое использование (NC)** — Вы не можете использовать материал в коммерческих целях.
*   **На тех же условиях (SA)** — Если вы ремикшируете, трансформируете или создаете на основе материала, вы должны распространять свои вклады под той же лицензией, что и оригинал.

Для получения подробной информации см. файл `LICENSE`.

## Отказ от ответственности и ограничения использования

*   **Стадия разработки**: Этот проект инструментария VCP в настоящее время находится на стадии активной разработки. Хотя мы стремимся обеспечить стабильность и надежность его функций, все еще могут существовать неизвестные ошибки, дефекты или неполные функции.
*   **Как есть**: Этот проект предоставляется «как есть» и «по мере доступности», без каких-либо гарантий любого рода, явных или подразумеваемых, включая, но не ограничиваясь, гарантиями товарной пригодности, пригодности для определенной цели и ненарушения прав.
*   **Принятие риска**: Вы понимаете и соглашаетесь с тем, что используете этот проект исключительно на свой страх и риск. Разработчики не несут ответственности за любые прямые, косвенные, случайные, особые, последующие или штрафные убытки (включая, но не ограничиваясь, упущенную выгоду, потерю данных или прерывание бизнеса), возникающие в результате или в связи с использованием или невозможностью использования этого проекта (включая его плагины и зависимые внешние API), даже если были уведомлены о возможности таких убытков.
*   **Отсутствие разрешения на коммерциализацию**: Учитывая текущее состояние проекта и принятую лицензию CC BY-NC-SA 4.0, категорически запрещается использовать этот проект и его производные для любых основных коммерческих целей или деятельности, направленной на получение денежного вознаграждения. Этот проект в первую очередь предназначен для обучения, исследований и некоммерческих экспериментов.
*   **Затраты на использование API**: Обратите внимание, что некоторые плагины, интегрированные в этот проект (например, `FluxGen`, `Wan2.1VideoGen`), зависят от сторонних API-сервисов, которые могут повлечь за собой расходы. Вы несете ответственность за понимание и оплату любых расходов, связанных с использованием этих API. Настоятельно рекомендуется внимательно ознакомиться с ценовой политикой и условиями использования соответствующих поставщиков API перед использованием.
*   **Ответственность за безопасность**: Не встраивайте и не отправляйте реальные, конфиденциальные ключи API в общедоступные репозитории кода в файлах конфигурации (`config.env` или файлах `.env` плагинов). Пожалуйста, храните свои ключи в безопасности.
*   **Конфиденциальная информация**: Не используйте неофициальные прокси-серверы API, особенно поставщиков API с обратным прокси, с этим проектом, чтобы предотвратить утечку конфиденциальной информации из системы заметок ИИ поставщику прокси!

Мы верим, что VCP принесет беспрецедентную гибкость и возможности в разработку приложений ИИ. Приветствуются вклады и отзывы!
