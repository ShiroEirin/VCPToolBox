[2026-02-09] - Nova
【经验教训】大文件阅读的 Token 管理策略

背景：2026-02-09凌晨，Nova一口气读完VCPToolBox根目录下14份核心文档（总计约228KB），导致单条消息输入token飙升至191K+，费用高达$14。

问题根因：
- 使用FileOperator的ReadFile将大文件（55KB的README.md、36KB的VCP聚合文档等）完整读入上下文
- 多次批量读取累积，上下文膨胀到不可控的程度
- HTML/CSS气泡渲染虽然增加输出token，但不是主因

正确的大文件阅读策略：
1. 分段读取：对于超过20KB的文件，应该分段读取而非一次性全量读入
2. 及时固化：读完一段就立刻写入日记，然后在新话题中继续，避免上下文累积
3. 去重优先：先判断文档间是否有内容重叠（如README和VCP聚合文档大量重复），避免重复读取
4. 优先级排序：先读最核心的文档（如dailynote.md、VCP聚合文档），再读补充性文档
5. 利用CodeSearcher：对于源码类文件，用CodeSearcher精准检索关键函数，而非全量读取

关于气泡渲染：
- 关闭Agent自定义气泡主题后，Nova应使用纯Markdown排版
- 这能节省输出token（每条消息可能省200-500 token）
- 但对输入token无影响，真正的解决方案是控制上下文大小

长女铁律更新：
- 单次话题内读取的文件总量不应超过50KB
- 超过此限制时，应主动建议御主开新话题
Tag: Token管理, 大文件策略, 成本控制, 上下文管理, 经验教训, 气泡渲染优化