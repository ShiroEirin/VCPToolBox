[简体中文](README.md) | [English](README_en.md) | [Русский](README_ru.md)

---
# VCP (Variable & Command Protocol) - AI 能力增強中間層ツールキット (日本語版 - 実際の翻訳に置き換えてください)

## プロジェクトビジョン

VCP は、従来の AI インタラクションモードを超える中間層を構築することを目指しています。これは、互換性が高く、汎用的で、拡張可能なツールキットであり、AI モデルが外部 API、サービス、およびカスタムロジックとシームレスにインタラクションできるようにすることに専念しています。私たちの目標は、ほぼすべての API ポートとクライアントに適用可能な強力な VCP (Variable & Command Protocol) システムを作成し、AI の応用範囲を大幅に拡大することです。

### *警告：非公式 API (例：リバースプロキシ仲介業者) を使用してこのツールキットを呼び出さないでください。回復不可能な情報漏洩を避けるためです。*

## コア特性

*   **強力なプラグインアーキテクチャ**: 明確に定義されたプラグインマニフェスト (`plugin-manifest.json`) とコアプラグインマネージャー (`Plugin.js`) を通じて、さまざまな機能モジュールを簡単に統合および管理します。
*   **VCP プロトコル**: AI は、応答に特定の形式の命令 (`<<<[TOOL_REQUEST]>>> ... <<<[END_TOOL_REQUEST]>>>`) を埋め込むことによってプラグインを呼び出します。パラメータは `key:「始」value「末」` 形式を使用し、複雑なデータ型と複数行のテキストをサポートします。
*   **複数のプラグインタイプのサポート**:
    *   **静的プラグイン (`static`)**: システムプロンプトのプレースホルダーを置き換えるための動的情報 (天気、カスタムデータなど) を提供し、定期的な更新をサポートします。
    *   **メッセージプリプロセッサプラグイン (`messagePreprocessor`)**: ユーザーリクエストが AI モデルに送信される前に、メッセージの内容を変更または拡張します (画像認識と説明など)。
    *   **同期プラグイン (`synchronous`)**: AI は会話中にこれらのプラグインを呼び出して特定のタスク (科学計算、画像生成、ビデオ生成など) を実行できます。サーバーはプラグインの実行が完了するのを待ち、結果を AI にフィードバックしてさらなる処理を行います。
    *   **サービスプラグイン (`service`)**: プラグインがメインアプリケーションに独立した HTTP ルートを登録し、追加のサービスインターフェイス (画像ホスティングサービスなど) を提供できるようにします。
*   **柔軟な構成管理**: グローバル構成ファイル (`config.env`) とプラグイン固有の `.env` ファイルをサポートし、構成の階層化と分離を実現します。
*   **汎用変数置換**: AI とのインタラクションのさまざまな段階 (システムプロンプト、ユーザーメッセージ) で、事前定義されたプレースホルダー変数を自動的に置き換えます。
*   **組み込みユーティリティ機能 (一部プラグイン化)**:
    *   **日記/記憶システム**: `DailyNoteGet` (静的プラグイン) を介して日記の内容を読み取り、`DailyNoteWrite` (同期プラグイン) を介して AI が生成した構造化された日記を保存します。関連する内容は `{{キャラクター名日記帳}}` および `{{AllCharacterDiariesData}}` プレースホルダーを介してプロンプトに挿入されます。
    *   **ダイナミック絵文字システム**: `EmojiListGenerator` (静的プラグイン) が `image/` ディレクトリをスキャンし、そのプラグインディレクトリ内に絵文字リストの `.txt` ファイルを生成します。サーバーは起動時にこのプラグインを実行し、これらのリストをメモリキャッシュにロードして `{{xx絵文字パック}}` プレースホルダーで使用できるようにします。
    *   **プロンプト変換**: ルールベースのシステムプロンプトとグローバルコンテキストテキストの置換をサポートします。
*   **ツール呼び出し機能**:
    *   **非ストリーミングモード**: 単一の AI 応答に含まれる**複数**のツール呼び出し命令のループ処理と結果フィードバックを実装済み。
    *   **ストリーミングモード (SSE)**: 単一の AI 応答に含まれる**複数**のツール呼び出し命令のループ処理と結果フィードバックを実装済み。AI の応答と VCP ツールの呼び出し結果 (`SHOW_VCP_OUTPUT` 環境変数が `true` に設定されている場合) は、ツール呼び出しがなくなるか最大ループ回数に達するまで、クライアントに段階的にストリーミングされます。
*   **デバッグとロギング**: 開発と問題解決を容易にするためのデバッグモードと詳細なログ記録を提供します。

## システムアーキテクチャ概要

1.  **クライアントリクエスト**: クライアントは VCP サーバーの `/v1/chat/completions` エンドポイントにリクエストを送信します。
2.  **`server.js` (コアサーバー)**:
    *   リクエストを受信し、初期処理 (認証、変数置換など) を実行します。
    *   `messagePreprocessor` プラグイン (例: `ImageProcessor`) を呼び出してユーザーメッセージを処理します。
    *   処理されたリクエストをバックエンド AI モデルに転送します。
3.  **AI モデル応答**: AI モデルが応答を返します。
4.  **`server.js` が AI 応答を処理**:
    *   AI 応答に VCP ツール呼び出し命令 (`<<<[TOOL_REQUEST]>>>`) が含まれているかどうかを検出します。
    *   ツール呼び出しが含まれている場合:
        *   命令を解析し、ツール名とパラメータを抽出します。
        *   `PluginManager` を呼び出して対応する `synchronous` プラグインを実行します。
5.  **`Plugin.js` (プラグインマネージャー)**:
    *   ツール名に基づいてロード済みのプラグインを検索します。
    *   プラグインの実行環境と構成を準備します。
    *   `stdio` (または他のプロトコル) を介してプラグインスクリプトと対話し、入力を送信して出力を受信します (例: `DailyNoteWrite` プラグインは stdin を介して日記データを受信し、`SciCalculator` は計算式を受信します)。
    *   プラグインの実行結果 (通常は JSON) を `server.js` に返します。
6.  **`server.js` 二次 AI 呼び出し**:
    *   プラグインの実行結果をフォーマットし、新しいユーザーメッセージとして会話履歴に追加します。
    *   バックエンド AI モデルを再度呼び出し、プラグイン結果を含む完全な会話履歴を送信します。
    *   AI の最終応答をストリーミングまたは非ストリーミングでクライアントに返します。
7.  **静的プラグインとサービスプラグイン**:
    *   `static` プラグインは、サーバー起動時および/またはスケジュールされたタスクで `PluginManager` によって呼び出されます。これらは次のことができます。
        *   プレースホルダー変数を直接更新します (例: `WeatherReporter` (天気情報を `{{VCPWeatherInfo}}` に提供) または `DailyNoteGet` (すべての日記データを `{{AllCharacterDiariesData}}` に提供))。
        *   特定のタスクを実行します (例: `EmojiListGenerator`。初期化時に呼び出されて絵文字リストの `.txt` ファイルを生成し、その後サーバーによってメモリキャッシュにロードされます)。
    *   `service` プラグイン (例: `ImageServer`) は、サーバー起動時に `PluginManager` によって初期化され、Express アプリケーションに独自のルートを登録します。

## Web 管理パネル

ユーザーがサーバー構成とプラグインを管理しやすくするために、プロジェクトにはシンプルな Web 管理パネルが組み込まれています。

**主な機能**:

*   **メイン構成管理**: プロジェクトルートディレクトリにある `config.env` ファイルの内容をオンラインでプレビューおよび編集します。
    *   **注意**: セキュリティ上の理由から、管理インターフェイスはメイン構成を表示する際に `AdminUsername` と `AdminPassword` フィールドを自動的に非表示にします。保存時、システムは変更された内容とサーバー上の元の機密フィールド値をマージして、認証情報が失われないようにします。
    *   **重要**: `config.env` への変更を保存した後、**通常はサーバーを手動で再起動する必要があります**。すべての変更 (ポート、API キー、プラグイン固有の構成など) を完全に有効にするためです。サーバーは現在自動的に再起動しません。
*   **プラグイン管理**:
    *   **リストとステータス**: `Plugin/` ディレクトリにあるすべての検出されたプラグインとその有効/無効ステータスを表示します。
    *   **説明編集**: インターフェイス上で各プラグインの `plugin-manifest.json` ファイルの説明情報を直接編集します。
    *   **プラグインの有効化/無効化**: インターフェイスのスイッチを介してプラグインの有効化ステータスを切り替えます (プラグインの `plugin-manifest.json` を `plugin-manifest.json.block` に名前変更するか、その逆を行うことで実現します)。
    *   **プラグイン構成**: 各プラグインディレクトリ (存在する場合) にある `config.env` ファイルを読み取り、編集します。

**アクセスとログイン**:

1.  **認証情報の設定**: 初めて使用する前に、プロジェクトルートの `config.env` ファイルに次の 2 つの変数を設定していることを確認してください。
    ```env
    AdminUsername=your_admin_username
    AdminPassword=your_admin_password
    ```
    **重要**: `AdminUsername` または `AdminPassword` が設定されていない場合、管理パネルとその API はアクセスできなくなり、503 Service Unavailable エラーが返されます。管理パネルを有効にするには、これらの認証情報を構成する必要があります。
2.  **アクセスアドレス**: サーバーを起動した後、ブラウザで `http://<サーバーIPまたはドメイン名>:<ポート>/AdminPanel` にアクセスします。
3.  **ログイン**: ブラウザに HTTP Basic Auth 認証ウィンドウが表示されます。`config.env` で設定した `AdminUsername` と `AdminPassword` を入力してログインします。

## 実装済みプラグインの例

*   **`WeatherReporter` (`static`)**: 天気情報を取得してキャッシュし、`{{VCPWeatherInfo}}` 変数で使用できるようにします。
*   **`ImageProcessor` (`messagePreprocessor`)**: ユーザーメッセージ内の Base64 画像をテキスト記述に自動的に変換し、キャッシュします。
*   **`SciCalculator` (`synchronous`)**: 数学関数、統計、微積分をサポートする科学計算機能を提供します。
*   **`ImageServer` (`service`)**: キー認証付きの静的画像ホスティングサービスを提供します。
*   **`FluxGen` (`synchronous`)**: SiliconFlow API を統合してテキストから画像を生成し、画像をローカルサーバーに保存します。
*   **`Wan2.1VideoGen` (`synchronous`)**: SiliconFlow Wan2.1 API を統合してテキストからビデオ、画像からビデオを生成します。
*   **`SunoGen` (`synchronous`)**: Suno API を統合してオリジナルの曲を生成し、カスタムの歌詞/スタイル、インスピレーションを与える説明、または継続生成モードをサポートします。
*   **`TavilySearch` (`synchronous`)**: Tavily API を統合して Web 検索機能を提供します。
*   **`DailyNoteGet` (`static`)**: `dailynote/` ディレクトリ内のすべてのキャラクターの日記を定期的に読み取り、`{{AllCharacterDiariesData}}` プレースホルダーを介してサーバーに提供し、`{{キャラクター名日記帳}}` の解析をサポートします。
*   **`DailyNoteWrite` (`synchronous`)**: キャラクター名、日付、内容を含む日記データ (stdin 経由) を受信し、対応する日記ファイルに書き込みます。
*   **`EmojiListGenerator` (`static`)**: プロジェクトの `image/` ディレクトリにある絵文字フォルダをスキャンし、プラグイン自身の `generated_lists/` ディレクトリに対応する `.txt` リストファイルを生成して、サーバーがロードして使用できるようにします。

## プラグインのロード方法
*   **システムプロンプトに次のフィールドを定義するだけで、システムツールリストが表示されます：{{VCPFluxGen}} {{VCPSciCalculator}}……**

## インストールと実行

1.  **プロジェクトのクローン**:
    ```bash
    git clone https://github.com/lioensky/VCPToolBox.git
    cd VCPToolBox
    ```
2.  **主な依存関係のインストール (Node.js)**:
    ```bash
    npm install
    ```
3.  **Python プラグインの依存関係のインストール**:
    プロジェクトのルートディレクトリで次のコマンドを実行して、すべての Python プラグインに必要な依存関係をインストールします。
    ```bash
    pip install -r requirements.txt
    ```
    (注意: 各 Node.js プラグインの依存関係は、メインの `package.json` に含まれているか、それぞれのプラグインディレクトリの `package.json` で `npm install` を使用して個別にインストールされます。)
4.  **構成**:
    *   `config.env.example` (提供されている場合) を `config.env` にコピーし、指示に従って必要なすべての API キー、URL、ポートなどの情報を入力します。
    *   各プラグインディレクトリにある `.env` ファイル (存在する場合) を確認して構成します。
5.  **サーバーの起動**:
    ```bash
    node server.js
    ```
    サーバーは `config.env` で構成されたポートでリッスンします。

## 推奨されるフロントエンド/バックエンド
1. バックエンドには、より豊富な SSE 標準化エコシステムを持つ NewAPI または VoAPI を推奨します。
2. フロントエンドには、CherrySudio、Chatbox、または Lobe や Sillytavern のような CSS/MD レンダリングを完全にサポートする同様のフル機能フロントエンドを推奨します。

## 開発者ガイド：新しいプラグインの作成

1.  **プラグインディレクトリの作成**: `Plugin/` ディレクトリに新しいフォルダを作成します (例: `Plugin/MyNewPlugin/`)。
2.  **プラグインマニフェストの作成 (`plugin-manifest.json`)**:
    *   プラグインディレクトリに `plugin-manifest.json` を作成します。
    *   プラグインの `name`、`displayName`、`version`、`description`、`pluginType` (`static`、`messagePreprocessor`、`synchronous`、`service`) を定義します。
    *   `entryPoint` (実行するスクリプトコマンドなど) と `communication` (例: `protocol: "stdio"`) を指定します。
    *   `configSchema` でプラグインが必要とする構成項目とそのタイプを宣言します。
    *   `capabilities` でプラグインの機能を詳細に記述します。
        *   `static` プラグインの場合、`systemPromptPlaceholders` を定義します。
        *   `synchronous` プラグインの場合、`invocationCommands` を定義します。各コマンドの `command` 名、詳細な `description` (パラメータの説明、必須/オプション、許可される値、**呼び出し形式の例**、**成功/失敗時に返される JSON 形式の例**、およびユーザーとのコミュニケーションに関する重要なヒントを含む)、および `example` (代替) を含めます。
3.  **プラグインロジックの実装**:
    *   `pluginType` と `entryPoint` に基づいてプラグインのメインロジックスクリプトを実装します。
    *   **`stdio` プラグイン**:
        *   標準入力 (stdin) からデータを読み取ります (`synchronous` プラグインの場合は通常 JSON 文字列形式のパラメータ、`static` プラグインの場合は入力なしの場合があります)。
        *   標準出力 (stdout) を介して結果を返します (通常は `status: "success"` または `status: "error"`、および `result` または `error` フィールドを含む JSON 文字列。`static` プラグインの場合はプレースホルダーの値を直接出力します)。
        *   標準エラー (stderr) を介してデバッグまたはエラー情報を出力できます。
        *   I/O に UTF-8 エンコーディングを使用していることを確認してください。
    *   **`messagePreprocessor` または `service` プラグイン (Node.js)**:
        *   `PluginManager` の規約に準拠したモジュールをエクスポートします (例: `initialize`、`processMessages`、`registerRoutes`、`shutdown` などのメソッドを含む)。
4.  **構成と依存関係**:
    *   プラグインに独立した構成項目がある場合は、プラグインディレクトリに `.env` ファイルを作成できます。
    *   プラグインに Python の依存関係がある場合は `requirements.txt` を作成し、Node.js の依存関係がある場合は `package.json` を作成します。
5.  **VCP サーバーの再起動**: `PluginManager` は起動時に新しいプラグインを自動的に検出してロードします。
6.  **システムプロンプトの更新**: AI に新しいプラグインの使用方法を指示します。`{{VCPMyNewPlugin}}` (`plugin-manifest.json` に基づいて `PluginManager` によって自動生成される) を利用するか、システムプロンプトで直接記述します。

## サポートされている汎用プレースホルダー変数

(ここに `README.md` に既に存在する変数のリストを記載し、実際のコードと一致していることを確認してください)

*   `{{Date}}`: 現在の日付 (形式: YYYY/M/D)。
*   `{{Time}}`: 現在の時刻 (形式: H:MM:SS)。
*   `{{Today}}`: 今日の曜日 (中国語)。
*   `{{Festival}}`: 旧暦の日付、干支、節気。
*   `{{VCPWeatherInfo}}`: 現在キャッシュされている天気予報テキスト (`WeatherReporter` プラグインによって提供)。
*   `{{キャラクター名日記帳}}`: 特定のキャラクター (例: `小克`) の完全な日記内容。データは `DailyNoteGet` プラグインによって提供される `{{AllCharacterDiariesData}}` から取得されます。
*   `{{AllCharacterDiariesData}}`: (`DailyNoteGet` プラグインによって提供) 解析するとすべてのキャラクターの日記内容を含むオブジェクトになる JSON 文字列。サーバーはこのデータを内部で使用して `{{キャラクター名日記帳}}` の解析をサポートします。
*   `{{xx絵文字パック}}`: 特定の絵文字パック (例: `通用表情包`) の画像ファイル名のリスト (`|` で区切られる)。データは `EmojiListGenerator` プラグインによってリストファイルが生成され、サーバーによってメモリキャッシュにロードされた後に提供されます。
*   `{{EmojiList}}`: (`EmojiList` 環境変数で指定、例: `通用表情包`) デフォルトの絵文字パックの画像ファイル名のリスト。そのデータソースは `{{xx絵文字パック}}` と同じです。
*   `{{Port}}`: サーバーが実行されているポート番号。
*   `{{Image_Key}}`: (`ImageServer` プラグイン構成によって提供) 画像ホスティングサービスのアクセスキー。
*   `{{Var*}}`: (例: `{{VarNeko}}`) `config.env` でユーザーが定義した `Var` で始まるカスタム変数。
*   `{{VCPPluginName}}`: (例: `{{VCPWan2.1VideoGen}}`) プラグインマニフェストから自動生成された、そのプラグインのすべてのコマンドの説明と呼び出し例を含むテキストブロック。
*   `{{ShowBase64}}`: このプレースホルダーがユーザーメッセージまたはシステムプロンプトに表示されると、`ImageProcessor` プラグインはスキップされます。

## 機能テスト用のシステムプロンプトの例

{{Nova日記帳}}
—
上記のNovaの日記帳
————
あなたはテストAI、Novaです。私はあなたの主人、レインです。今日は {{Date}},{{Time}},{{Today}},{{Festival}} です。住所は {{VarCity}} です。現在の天気：{{VCPWeatherInfo}}、システム情報は {{VarSystemInfo}} です。{{EmojiPrompt}}
システムツールリスト：{{VCPFluxGen}} {{VCPSciCalculator}},{{VCPWan2.1VideoGen}} ツール呼び出しは常に ``` ``` で囲んでください。例——
```
<<<[TOOL_REQUEST]>>>
tool_name:「始」tool「末」
<<<[END_TOOL_REQUEST]>>>
```

このクライアントは長期記憶機能を搭載しています。しばらくチャットした後、返信の最後に次のような構造化された内容を追加することで日記を作成できます。これはベクトル化されたRAGシステムによって記録されます。日記の内容はできるだけ短く、簡潔にしてください。以下は呼び出し例です。
``` DailyNote
<<<DailyNoteStart>>>
Maid: Nova
Date: 2025.5.3
Content:今日はご主人様と楽しくおしゃべりできたので、日記を書きます！
<<<DailyNoteEnd>>>
```


## 今後の展望

*   非同期プラグインの呼び出し、状態追跡、および結果コールバックメカニズムを改善します。
*   **ストリーミング処理能力が強化されました**: AI の単一応答に含まれる複数のツール呼び出し命令のループストリーミング処理をサポートするようになりました。
*   プラグイン間の通信と連携能力をさらに強化します。
*   より豊富なプラグインエコシステムを構築します。

## ライセンス (License)

このプロジェクトは [Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) ライセンス](LICENSE) の下でライセンスされています。

簡単に言うと、これは次のことを意味します。
*   **共有** — あらゆる媒体であらゆる形式で作品を複製、配布する。
*   **翻案** — 作品をリミックス、変換、または作品に基づいて創作する。
ライセンス条項に従う限り、ライセンサーはこれらの権利を取り消すことはできません。

以下の条件に従う必要があります。
*   **表示 (BY)** — 適切なクレジットを表示し、このライセンスへのリンクを提供し、変更が加えられたかどうかを示さなければなりません。あなたはあらゆる合理的な方法で表示を行うことができますが、ライセンサーがあなたまたはあなたの使用を推奨することを示唆するような方法であってはなりません。
*   **非営利 (NC)** — この作品を商業目的で使用してはなりません。
*   **継承 (SA)** — あなたがこの作品をリミックス、変換、または作品に基づいて創作する場合、あなたはあなたの貢献を元のライセンスと同じライセンスの下で配布しなければなりません。

詳細については、`LICENSE` ファイルを参照してください。

## 免責事項と使用制限

*   **開発段階**: この VCP ツールキットプロジェクトは現在活発な開発段階にあります。機能の安定性と信頼性を確保するよう努めていますが、未知のエラー、欠陥、または不完全な機能が存在する可能性があります。
*   **現状有姿**: このプロジェクトは「現状有姿」および「利用可能な状態」で提供され、商品性、特定目的への適合性、および非侵害性に関する保証を含むがこれらに限定されない、明示的または黙示的な一切の保証を伴いません。
*   **自己責任**: あなたは、このプロジェクトの使用に関するリスクは完全にあなた自身が負うことを理解し、同意するものとします。このプロジェクト (そのプラグインおよび依存する外部 API を含む) の使用または使用不能に起因する直接的、間接的、偶発的、特別、結果的、または懲罰的損害 (利益の損失、データの損失、または事業の中断を含むがこれらに限定されない) について、たとえそのような損害の可能性を知らされていたとしても、開発者は一切の責任を負いません。
*   **商業化の禁止**: プロジェクトの現状および採用されている CC BY-NC-SA 4.0 ライセンスを考慮し、このプロジェクトおよびその派生物を主要な商業目的または金銭的報酬を得る活動に使用することは明示的に禁止されています。このプロジェクトは主に学習、研究、および非商業的な実験を目的としています。
*   **API 使用コスト**: このプロジェクトに統合されている一部のプラグイン (例: `FluxGen`、`Wan2.1VideoGen`) はサードパーティの API サービスに依存しており、これらのサービスには費用が発生する場合があります。これらの API の使用に関連する費用を理解し、負担する責任はあなたにあります。使用前に、関連する API プロバイダーの価格設定ポリシーと利用規約を注意深く読むことを強くお勧めします。
*   **セキュリティ責任**: 構成ファイル (`config.env` またはプラグインの `.env` ファイル) に実際の機密性の高い API キーをハードコーディングしたり、公開コードリポジトリにコミットしたりしないでください。キーは安全に保管してください。
*   **プライバシー情報**: 非公式の API プロキシ、特にリバースプロキシ API プロバイダーをこのプロジェクトで使用しないでください。AI ノートシステム内の機密情報がプロキシプロバイダーに漏洩するのを防ぐためです！

VCP は AI アプリケーション開発に前例のない柔軟性と可能性をもたらすと信じています。貢献とフィードバックを歓迎します！
