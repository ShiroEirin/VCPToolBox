<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self' data:;
                   script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
                   style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
                   img-src * data: file:;
                   media-src * data: file:;
                   font-src 'self' https://cdn.jsdelivr.net;
                   connect-src * ws: wss:;">
    <title>VCPChat</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> <!-- 添加 marked.js -->
</head>
<body>
    <div class="title-bar">
        <div class="title-bar-text"><img src="assets/icon.png" alt="Logo" class="title-bar-logo"> VCPChat</div>
        <div class="title-bar-controls">
            <button id="settings-btn" class="title-bar-button" title="设置">
                <svg viewBox="0 0 10 10">
                    <polygon points="5,8 0,2 10,2"></polygon>
                </svg>
            </button>
            <button id="minimize-btn" class="title-bar-button" title="最小化">
                <svg x="0px" y="0px" viewBox="0 0 10.2 1"><rect x="0" y="0" width="10.2" height="1"></rect></svg>
            </button>
            <button id="maximize-btn" class="title-bar-button" title="最大化">
                <svg viewBox="0 0 10 10"><path d="M0,0v10h10V0H0z M9,9H1V1h8V9z"></path></svg>
            </button>
            <button id="restore-btn" class="title-bar-button" title="还原" style="display: none;">
                <svg viewBox="0 0 10.2 10.1"><path d="M2.1,0v2H0v8.1h8.2v-2h2V0H2.1z M7.2,9.2H1.1V3h6.1V9.2z M9.2,7.1h-1V2H3.1V1h6.1V7.1z"></path></svg>
            </button>
            <button id="close-btn" class="title-bar-button close-button" title="关闭">
                <svg viewBox="0 0 10 10"><polygon points="10,1.01 8.99,0 5,3.99 1.01,0 0,1.01 3.99,5 0,8.99 1.01,10 5,6.01 8.99,10 10,8.99 6.01,5"></polygon></svg>
            </button>
        </div>
    </div>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-tabs">
                <button class="sidebar-tab-button active" data-tab="agents">助手</button>
                <button class="sidebar-tab-button" data-tab="topics">话题</button>
                <button class="sidebar-tab-button" data-tab="settings">设置</button>
            </div>
            <div class="sidebar-tab-content active" id="tabContentAgents">
                <h2>VCP Agents</h2>
                <ul class="agent-list" id="agentList">
                    <!-- 示例:
                    <li class="active" data-agent-id="xiaoke">
                        <img src="path/to/xiaoke_avatar.png" alt="小克头像" class="avatar">
                        <span class="agent-name">猫娘小克</span>
                    </li>
                    -->
                </ul>
                <div class="sidebar-actions">
                    <button id="createNewAgentBtn" class="sidebar-button create-agent-btn">创建新Agent</button>
                </div>
            </div>
            <div class="sidebar-tab-content" id="tabContentTopics">
                <!-- 话题内容区 -->
                <div class="topics-header">
                    <h2>话题</h2>
                    <div class="topic-search-container">
                        <input type="text" id="topicSearchInput" placeholder="搜索话题..." class="topic-search-input">
                        <!-- Search button removed -->
                    </div>
                </div>
                <ul class="topic-list" id="topicList">
                    <!-- 话题列表将在这里动态加载 -->
                </ul>
            </div>
            <div class="sidebar-tab-content" id="tabContentSettings">
                <!-- 设置内容区 -->
                <div class="settings-header-bar">
                    <h2>设置</h2>
                    <button id="globalSettingsBtn" class="sidebar-button global-settings-btn">全局设置</button>
                </div>
                
                <div id="agentSettingsContainer" style="display: none;"> <!-- Initially hidden -->
                    <h3 id="agentSettingsContainerTitle">助手设置: <span id="selectedAgentNameForSettings"></span></h3>
                    <form id="agentSettingsForm">
                        <input type="hidden" id="editingAgentId" name="agentId">
                        <div>
                            <label for="agentNameInput">Agent 名称:</label>
                            <input type="text" id="agentNameInput" name="name" required>
                        </div>
                        <div>
                            <label for="agentAvatarInput">Agent 头像 (留空不更改):</label>
                            <input type="file" id="agentAvatarInput" name="avatar" accept="image/png, image/jpeg, image/gif">
                            <img id="agentAvatarPreview" src="#" alt="头像预览" style="max-width: 80px; max-height: 80px; display: none; margin-top: 5px;">
                        </div>
                        <div>
                            <label for="agentSystemPrompt">系统提示词 (可使用 `{{AgentName}}` 占位符):</label>
                            <textarea id="agentSystemPrompt" name="systemPrompt" rows="6"></textarea>
                        </div>
                        <div>
                            <label for="agentModel">模型名称:</label>
                            <input type="text" id="agentModel" name="model" placeholder="例如 gemini-2.5-flash-preview-05-20">
                        </div>
                        <div>
                            <label for="agentTemperature">Temperature (0-1):</label>
                            <input type="number" id="agentTemperature" name="temperature" min="0" max="1" step="0.1">
                        </div>
                        <div>
                            <label for="agentContextTokenLimit">上下文Token上限:</label>
                            <input type="number" id="agentContextTokenLimit" name="contextTokenLimit" min="0" step="100">
                        </div>
                         <div>
                            <label for="agentMaxOutputTokens">最大输出Token上限:</label>
                            <input type="number" id="agentMaxOutputTokens" name="maxOutputTokens" min="0" step="50">
                        </div>
                        <div>
                            <label>输出模式:</label>
                            <label for="agentStreamOutputTrue">
                                <input type="radio" id="agentStreamOutputTrue" name="streamOutput" value="true" checked> 流式
                            </label>
                            <label for="agentStreamOutputFalse">
                                <input type="radio" id="agentStreamOutputFalse" name="streamOutput" value="false"> 非流式
                            </label>
                        </div>
                        <div class="form-actions">
                            <button type="submit">保存Agent设置</button>
                            <button type="button" id="deleteAgentBtn" class="danger-button">删除此Agent</button>
                        </div>
                    </form>
                </div>
                <p id="selectAgentPromptForSettings" style="display: block;">请先在“助手”标签页选择一个Agent以查看或修改其设置。</p>
            </div>
        </aside>
        <div class="resizer" id="resizerLeft"></div>
        <main class="main-content">
            <header class="chat-header">
                <h3 id="currentChatAgentName">选择一个Agent开始聊天</h3>
                <div class="chat-actions">
                    <button id="themeToggleBtn" class="header-button" title="切换主题">☀️</button>
                    <button id="currentAgentSettingsBtn" class="header-button" title="当前Agent设置" style="display: none;">⚙️ Agent设置</button>
                    <button id="clearCurrentChatBtn" class="header-button" title="清空当前聊天记录" style="display: none;">🗑️ 清空对话</button>
                </div>
            </header>
            <div class="chat-messages-container">
                <div class="chat-messages" id="chatMessages">
                    </div>
            </div>
            <footer class="chat-input-area">
                <div class="attachment-preview-area" id="attachmentPreviewArea"></div>
                <textarea id="messageInput" placeholder="输入消息... (Shift+Enter 换行)" rows="1" disabled></textarea>
                <button id="sendMessageBtn" title="发送消息 (Ctrl+Enter)" disabled>
                    <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
                 <button id="attachFileBtn" title="发送文件" disabled>
                    <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v11.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>
                </button>
            </footer>
        </main>
        <div class="resizer" id="resizerRight"></div>
        <aside class="notifications-sidebar" id="notificationsSidebar">
            <header class="notifications-header">
                <h4 id="notificationTitle" style="display: none;">VCP 通知</h4>
                <div class="datetime-container">
                    <div id="digitalClock" class="digital-clock"></div>
                    <div id="dateDisplay" class="date-display"></div>
                </div>
                <button id="clearNotificationsBtn" title="清空通知">清空</button>
            </header>
            <div class="notifications-status" id="vcpLogConnectionStatus">
                VCPLog: 未连接
            </div>
            <ul class="notifications-list" id="notificationsList">
                </ul>
        </aside>
    </div>

    <div class="modal" id="globalSettingsModal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('globalSettingsModal')">&times;</span>
            <h2>全局设置</h2>
            <form id="globalSettingsForm">
                <div>
                    <label for="vcpServerUrl">VCP 服务器 URL:</label>
                    <input type="url" id="vcpServerUrl" name="vcpServerUrl" required>
                </div>
                <div>
                    <label for="vcpApiKey">VCP API Key:</label>
                    <input type="password" id="vcpApiKey" name="vcpApiKey">
                </div>
                <div>
                    <label for="vcpLogUrl">VCP 通知 WebSocket URL:</label>
                    <input type="url" id="vcpLogUrl" name="vcpLogUrl">
                </div>
                <div>
                    <label for="vcpLogKey">VCP 通知 Key:</label>
                    <input type="text" id="vcpLogKey" name="vcpLogKey">
                </div>
                <button type="submit">保存全局设置</button>
            </form>
        </div>
    </div>

    <!-- Agent Settings Modal is now removed, its content moved to #tabContentSettings -->

    <script src="modules/topicSummarizer.js"></script>
    <script src="modules/notificationRenderer.js"></script>
    <script src="modules/messageRenderer.js"></script>
    <script src="modules/inputEnhancer.js"></script> <!-- Add inputEnhancer.js -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="renderer.js"></script>
</body>
</html>